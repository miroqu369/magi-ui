import React, { useState } from 'react';
import './App.css';

function App() {
  // メニュー状態
  const [menuOpen, setMenuOpen] = useState(false);
  const [currentPage, setCurrentPage] = useState('stock'); // stock, qa, document, settings

  // 質問応答の状態
  const [question, setQuestion] = useState('');
  const [qaResult, setQaResult] = useState(null);
  const [qaMode, setQaMode] = useState('integration');
  const [qaLoading, setQaLoading] = useState(false);

  // 株価分析の状態
  const [symbols, setSymbols] = useState(['AAPL', 'GOOGL', 'MSFT']);
  const [newSymbol, setNewSymbol] = useState('');
  const [stockResults, setStockResults] = useState({});
  const [stockLoading, setStockLoading] = useState(false);

  // 文書解析の状態
  const [docSymbol, setDocSymbol] = useState('');
  const [docText, setDocText] = useState('');
  const [docType, setDocType] = useState('sentiment');
  const [docResult, setDocResult] = useState(null);
  const [docLoading, setDocLoading] = useState(false);

  // 設定
  const [magiSysUrl, setMagiSysUrl] = useState('http://localhost:8080');
  const [magiAcUrl, setMagiAcUrl] = useState('http://localhost:8888');

  // ページ切り替え
  const navigateTo = (page) => {
    setCurrentPage(page);
    setMenuOpen(false);
  };

  // ========== 質問応答 ==========
  const submitQuestion = async () => {
    if (!question.trim()) return;
    setQaLoading(true);
    setQaResult(null);
    try {
      const response = await fetch(`${magiSysUrl}/api/consensus`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          prompt: question,
          meta: { mode: qaMode }
        })
      });
      const data = await response.json();
      setQaResult(data);
    } catch (error) {
      setQaResult({ error: error.message });
    } finally {
      setQaLoading(false);
    }
  };

  // ========== 株価分析 ==========
  const addSymbol = () => {
    if (newSymbol && !symbols.includes(newSymbol.toUpperCase())) {
      setSymbols([...symbols, newSymbol.toUpperCase()]);
      setNewSymbol('');
    }
  };

  const removeSymbol = (sym) => {
    setSymbols(symbols.filter(s => s !== sym));
    const newResults = { ...stockResults };
    delete newResults[sym];
    setStockResults(newResults);
  };

  const analyzeStock = async (symbol) => {
    setStockLoading(true);
    try {
      const response = await fetch(`${magiAcUrl}/api/ai-consensus`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ symbol })
      });
      const data = await response.json();
      setStockResults(prev => ({ ...prev, [symbol]: data }));
    } catch (error) {
      setStockResults(prev => ({ ...prev, [symbol]: { error: error.message } }));
    } finally {
      setStockLoading(false);
    }
  };

  const analyzeAllStocks = async () => {
    setStockLoading(true);
    for (const symbol of symbols) {
      await analyzeStock(symbol);
    }
    setStockLoading(false);
  };

  // ========== 文書解析 ==========
  const analyzeDocument = async () => {
    if (!docText.trim()) return;
    setDocLoading(true);
    setDocResult(null);
    try {
      const endpoint = docType === 'sentiment' 
        ? '/api/document/sentiment'
        : docType === 'financials'
        ? '/api/document/extract-financials'
        : '/api/document/summarize';
      
      const response = await fetch(`${magiAcUrl}${endpoint}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ symbol: docSymbol || 'UNKNOWN', text: docText })
      });
      const data = await response.json();
      setDocResult(data);
    } catch (error) {
      setDocResult({ error: error.message });
    } finally {
      setDocLoading(false);
    }
  };

  // ========== レンダリング ==========
  const renderQAPage = () => (
    <div className="page qa-page">
      <h2>質問応答 (5AI合議)</h2>
      <div className="qa-controls">
        <select value={qaMode} onChange={(e) => setQaMode(e.target.value)}>
          <option value="consensus">Consensus (多数決)</option>
          <option value="integration">Integration (統合)</option>
          <option value="synthesis">Synthesis (創発)</option>
        </select>
      </div>
      <textarea
        className="qa-input"
        value={question}
        onChange={(e) => setQuestion(e.target.value)}
        placeholder="質問を入力してください..."
        rows={4}
      />
      <button 
        onClick={submitQuestion} 
        disabled={qaLoading}
        className="btn-primary"
      >
        {qaLoading ? '処理中...' : '5AIに質問する'}
      </button>

      {qaResult && (
        <div className="qa-result">
          {qaResult.error ? (
            <div className="error">エラー: {qaResult.error}</div>
          ) : (
            <>
              <div className="final-answer">
                <h3>最終回答</h3>
                <p>{qaResult.final}</p>
              </div>
              <div className="ai-responses">
                <h3>各AIの回答</h3>
                <div className="response-grid">
                  {qaResult.balthasar && (
                    <div className="ai-card balthasar">
                      <h4>BALTHASAR-2 (Grok)</h4>
                      <p>{qaResult.balthasar}</p>
                    </div>
                  )}
                  {qaResult.melchior && (
                    <div className="ai-card melchior">
                      <h4>MELCHIOR-1 (Gemini)</h4>
                      <p>{qaResult.melchior}</p>
                    </div>
                  )}
                  {qaResult.casper && (
                    <div className="ai-card casper">
                      <h4>CASPER-3 (Claude)</h4>
                      <p>{qaResult.casper}</p>
                    </div>
                  )}
                  {qaResult.mary && (
                    <div className="ai-card mary">
                      <h4>MARY-4 (GPT-4)</h4>
                      <p>{qaResult.mary}</p>
                    </div>
                  )}
                  {qaResult.sophia && (
                    <div className="ai-card sophia">
                      <h4>SOPHIA-5 (Mistral)</h4>
                      <p>{qaResult.sophia}</p>
                    </div>
                  )}
                </div>
              </div>
              {qaResult.metrics && (
                <div className="metrics">
                  <span>応答時間: {qaResult.metrics.response_time_ms}ms</span>
                  <span>有効回答: {qaResult.metrics.valid_responses}/5</span>
                </div>
              )}
            </>
          )}
        </div>
      )}
    </div>
  );

  const renderStockPage = () => (
    <div className="page stock-page">
      <h2>株価分析 (4AI合議)</h2>
      <div className="stock-controls">
        <input
          type="text"
          value={newSymbol}
          onChange={(e) => setNewSymbol(e.target.value.toUpperCase())}
          placeholder="銘柄コード (例: NVDA)"
          onKeyPress={(e) => e.key === 'Enter' && addSymbol()}
        />
        <button onClick={addSymbol} className="btn-add">追加</button>
        <button onClick={analyzeAllStocks} disabled={stockLoading} className="btn-primary">
          {stockLoading ? '分析中...' : '全て分析'}
        </button>
      </div>

      <div className="symbol-tags">
        {symbols.map(symbol => (
          <span key={symbol} className="symbol-tag">
            {symbol}
            <button onClick={() => removeSymbol(symbol)}>×</button>
          </span>
        ))}
      </div>

      <div className="stock-results">
        {symbols.map(symbol => (
          <div key={symbol} className="stock-card">
            <div className="card-header">
              <h3>{symbol}</h3>
              <button onClick={() => analyzeStock(symbol)} disabled={stockLoading}>
                分析
              </button>
            </div>
            {stockResults[symbol] && (
              <div className="card-body">
                {stockResults[symbol].error ? (
                  <div className="error">{stockResults[symbol].error}</div>
                ) : (
                  <>
                    <div className={`recommendation ${stockResults[symbol].recommendation?.toLowerCase()}`}>
                      {stockResults[symbol].recommendation || 'N/A'}
                    </div>
                    <div className="confidence">
                      信頼度: {Math.round((stockResults[symbol].confidence || 0) * 100)}%
                    </div>
                    {stockResults[symbol].votes && (
                      <div className="votes">
                        BUY: {stockResults[symbol].votes.BUY || 0} / 
                        HOLD: {stockResults[symbol].votes.HOLD || 0} / 
                        SELL: {stockResults[symbol].votes.SELL || 0}
                      </div>
                    )}
                  </>
                )}
              </div>
            )}
          </div>
        ))}
      </div>
    </div>
  );

  const renderDocumentPage = () => (
    <div className="page document-page">
      <h2>文書解析 (ISABEL - Cohere)</h2>
      <div className="doc-controls">
        <input
          type="text"
          value={docSymbol}
          onChange={(e) => setDocSymbol(e.target.value.toUpperCase())}
          placeholder="関連銘柄 (例: AAPL)"
        />
        <select value={docType} onChange={(e) => setDocType(e.target.value)}>
          <option value="sentiment">センチメント分析</option>
          <option value="financials">財務数値抽出</option>
          <option value="summarize">文書要約</option>
        </select>
      </div>
      <textarea
        className="doc-input"
        value={docText}
        onChange={(e) => setDocText(e.target.value)}
        placeholder="解析するテキストを入力してください（決算報告、ニュース記事など）..."
        rows={8}
      />
      <button onClick={analyzeDocument} disabled={docLoading} className="btn-primary">
        {docLoading ? '解析中...' : '文書を解析'}
      </button>

      {docResult && (
        <div className="doc-result">
          {docResult.error ? (
            <div className="error">エラー: {docResult.error}</div>
          ) : (
            <pre>{JSON.stringify(docResult, null, 2)}</pre>
          )}
        </div>
      )}
    </div>
  );

  const renderSettingsPage = () => (
    <div className="page settings-page">
      <h2>設定</h2>
      <div className="settings-form">
        <div className="setting-item">
          <label>MAGI-SYS URL (質問応答)</label>
          <input
            type="text"
            value={magiSysUrl}
            onChange={(e) => setMagiSysUrl(e.target.value)}
          />
        </div>
        <div className="setting-item">
          <label>MAGI-AC URL (株価分析)</label>
          <input
            type="text"
            value={magiAcUrl}
            onChange={(e) => setMagiAcUrl(e.target.value)}
          />
        </div>
        <div className="setting-info">
          <p>Cloud Run使用時は以下のURLを設定:</p>
          <code>https://magi-app-398890937507.asia-northeast1.run.app</code>
          <code>https://magi-ac-398890937507.asia-northeast1.run.app</code>
        </div>
      </div>
    </div>
  );

  return (
    <div className="app">
      {/* ヘッダー */}
      <header className="app-header">
        <button className="hamburger" onClick={() => setMenuOpen(!menuOpen)}>
          ≡
        </button>
        <h1>MAGI System v4.0</h1>
      </header>

      {/* サイドメニュー */}
      <nav className={`side-menu ${menuOpen ? 'open' : ''}`}>
        <button className="menu-close" onClick={() => setMenuOpen(false)}>×</button>
        <ul>
          <li className={currentPage === 'qa' ? 'active' : ''} onClick={() => navigateTo('qa')}>
            質問応答
          </li>
          <li className={currentPage === 'stock' ? 'active' : ''} onClick={() => navigateTo('stock')}>
            株価分析
          </li>
          <li className={currentPage === 'document' ? 'active' : ''} onClick={() => navigateTo('document')}>
            文書解析
          </li>
          <li className={currentPage === 'settings' ? 'active' : ''} onClick={() => navigateTo('settings')}>
            設定
          </li>
        </ul>
      </nav>

      {/* オーバーレイ */}
      {menuOpen && <div className="overlay" onClick={() => setMenuOpen(false)} />}

      {/* メインコンテンツ */}
      <main className="main-content">
        {currentPage === 'qa' && renderQAPage()}
        {currentPage === 'stock' && renderStockPage()}
        {currentPage === 'document' && renderDocumentPage()}
        {currentPage === 'settings' && renderSettingsPage()}
      </main>
    </div>
  );
}

export default App;
